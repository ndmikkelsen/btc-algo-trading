---
triggers: ['land the plane', "let's land", 'wrap up', '/land']
---

# /land ‚Äî Session Landing Protocol

Execute ALL steps in order. /land is NOT complete until step 12 passes.

## Step 1: Sync Beads to Kanban

```bash
node .claude/scripts/sync-beads-to-todo.js
```

**On failure:** Report error and ask user how to proceed.

## Step 2: File Remaining Work

Check for incomplete work and file Beads issues with branch reference:

```bash
# Get current branch for reference
CURRENT_BRANCH=$(git branch --show-current)

# Check for TODOs, FIXMEs, or incomplete work
rg "TODO|FIXME|XXX|HACK" --type md --type sh --type js

# If found, create Beads issues with branch reference
bd create "Complete TODO: <description>" \
  --description="Branch: $CURRENT_BRANCH

Found in <file>:<line>

[Additional context]" \
  -t task -p 2
```

**Include branch name in all issue descriptions** for tracking and context.

## Step 3: Update Issue Status

```bash
# Close completed issues
bd close <id> --reason "Completed in this session"

# Update in-progress issues
bd update <id> --status open --comment "Pausing for next session"
```

## Step 4: Format Changed Documentation (Auto-fix)

Format any markdown files that were modified in this session:

```bash
# Get list of all modified markdown files (staged + unstaged)
CHANGED_MD=$(git diff --name-only HEAD | grep '\.md$' || echo "")

if [ -n "$CHANGED_MD" ]; then
  echo "üìù Formatting changed markdown files..."

  # Format each changed file
  for file in $CHANGED_MD; do
    if [ -f "$file" ]; then
      python3 .claude/scripts/format_markdown.py --yes "$file" || {
        echo "‚ùå Formatting failed for $file"
        echo "Please fix manually and re-run /land"
        exit 1
      }
    fi
  done

  echo "‚úì Markdown files formatted and ready to stage"
else
  echo "‚ÑπÔ∏è  No markdown files to format"
fi
```

**On failure:** Exit /land and ask user to fix formatting issues manually.

## Step 5: Check for Uncommitted Files

```bash
git status
```

If there are modified or untracked files (excluding `.gitignore`d files):

- Stage them: `git add <files>`
- Commit with descriptive conventional commit message

## Step 6: Push to Remote (MANDATORY)

```bash
git push origin <current-branch>
```

If push fails (e.g., behind remote), pull and retry:

```bash
git pull --rebase origin <current-branch>
git push origin <current-branch>
```

**CRITICAL**: Work is NOT complete until `git push` succeeds. NEVER stop before pushing.

## Step 6.5: Create Pull Request to dev

**Purpose:** Automate PR creation targeting `dev` branch

```bash
# Detect current branch
CURRENT_BRANCH=$(git branch --show-current)

# Skip PR creation if on protected branches
if [ "$CURRENT_BRANCH" = "dev" ] || [ "$CURRENT_BRANCH" = "main" ]; then
  echo "‚ÑπÔ∏è  On protected branch ($CURRENT_BRANCH), skipping PR creation"
  
# Check if PR already exists for this branch
elif gh pr view "$CURRENT_BRANCH" >/dev/null 2>&1; then
  echo "‚úì PR already exists for $CURRENT_BRANCH"
  PR_URL=$(gh pr view "$CURRENT_BRANCH" --json url -q .url)
  echo "   View at: $PR_URL"
  
# Create new PR to dev
else
  echo "üìù Creating PR to dev..."
  
  # Get commit summary for PR body
  COMMITS=$(git log origin/dev..HEAD --oneline --no-decorate)
  NUM_COMMITS=$(echo "$COMMITS" | wc -l | tr -d ' ')
  
  # Extract Beads issue references from commits
  BEADS_REFS=$(echo "$COMMITS" | grep -oE 'SB-[a-z0-9]{3}' | sort -u | tr '\n' ', ' | sed 's/,$//' || echo "None")
  
  # Determine PR title based on branch type
  if [[ "$CURRENT_BRANCH" =~ ^(feat|fix|docs|refactor|chore)/ ]]; then
    # Workflow branch - use latest commit message
    PR_TITLE=$(git log -1 --pretty=%s)
  else
    # Knowledge branch - generate descriptive title
    TOPIC="${CURRENT_BRANCH%%/*}"
    DATE="${CURRENT_BRANCH##*/}"
    PR_TITLE="docs(${TOPIC}): ${DATE} session"
  fi
  
  # Create PR with detailed body
  gh pr create --base dev \
    --title "$PR_TITLE" \
    --body "## Summary

$NUM_COMMITS commit(s) from \`$CURRENT_BRANCH\`

## Commits

\`\`\`
$COMMITS
\`\`\`

## Beads Issues
$BEADS_REFS

## Branch Info
**Branch:** \`$CURRENT_BRANCH\`  
**Target:** \`dev\`  
**Type:** $(if [[ "$CURRENT_BRANCH" =~ ^(feat|fix|docs|refactor|chore)/ ]]; then echo "Workflow"; else echo "Knowledge/Content"; fi)

## Context
See \`STICKYNOTE.md\` for full session context and technical details.

---
*Auto-generated by /land command*"
  
  if [ $? -eq 0 ]; then
    echo "‚úì PR created successfully"
    PR_URL=$(gh pr view "$CURRENT_BRANCH" --json url -q .url)
    echo "   $PR_URL"
  else
    echo "‚ö†Ô∏è  Failed to create PR automatically"
    echo "   Create manually with: gh pr create --base dev"
    echo "   Continuing with /land protocol..."
  fi
fi
```

**Verification:** PR exists or was created successfully before proceeding.

## Step 7: Write STICKYNOTE.md (BLOCKING)

‚ö†Ô∏è **THIS STEP IS MANDATORY ‚Äî DO NOT SKIP**

Write session handoff to `STICKYNOTE.md` (local only, gitignored):

```markdown
# Session Handoff

**Date:** [TODAY]
**Branch:** [branch name]
**Last Commit:** [hash] - [message]

## Completed This Session

- [what was accomplished]

## Key Files Changed

- [list of significant files]

## Beads Closed

- [list of closed beads with IDs]

## Pending/Follow-up (Ready Work)

[output of `bd ready`]

## Context for Next Session

[brief context for whoever picks this up next]

## Technical Notes

[any important technical details, gotchas, or decisions made]
```

**Verification:** Confirm file exists and has content before proceeding.

## Step 8: Capture Session to Cognee (BLOCKING)

‚ö†Ô∏è **THIS STEP IS MANDATORY ‚Äî DO NOT SKIP**

Cognee runs on the compute server at `btc-algo-trading-cognee.apps.compute.lan`.

### 8a. Capture Session History

Capture session context to Cognee for searchable history:

```bash
COGNEE_URL="${COGNEE_URL:-https://btc-algo-trading-cognee.apps.compute.lan}"

# Create session note file
SESSION_FILE="/tmp/session-$(date +%Y%m%d-%H%M%S).txt"
cat > "$SESSION_FILE" << 'EOF'
Session: [DATE]
Branch: [branch name]
Commit: [hash] - [message]

Completed:
- [bullet points]

Key Changes:
- [significant files/features]

Beads Closed:
- [IDs and titles]

Technical Decisions:
- [any important decisions or discoveries]

Challenges/Solutions:
- [what problems were encountered and how they were solved]

Related Documentation:
- [any .rules/ docs that are relevant]
EOF

# Upload to Cognee (skip if unreachable)
if curl -sk "${COGNEE_URL}/health" > /dev/null 2>&1; then
  curl -X POST "${COGNEE_URL}/api/v1/add" \
    -F "data=@$SESSION_FILE" \
    -F "datasetName=btc-sessions"

  curl -X POST "${COGNEE_URL}/api/v1/cognify" \
    -H "Content-Type: application/json" \
    -d '{"datasets": ["btc-sessions"]}'

  echo "‚úì Session captured to Cognee"
  COGNEE_REACHABLE=true
else
  echo "‚ö†Ô∏è  Cognee not reachable at ${COGNEE_URL}, skipping session capture"
  COGNEE_REACHABLE=false
fi
```

### 8b. Smart Sync Knowledge Garden

Sync `.claude/` and `.rules/` to Cognee if they changed this session:

```bash
COGNEE_URL="${COGNEE_URL:-https://btc-algo-trading-cognee.apps.compute.lan}"

# Check if knowledge garden files changed in this session
GARDEN_CHANGED=$(git diff --name-only origin/dev...HEAD | grep '^\(.claude/\|.rules/\)' || echo "")
CONSTITUTION_CHANGED=$(git diff --name-only origin/dev...HEAD | grep '^\(CONSTITUTION\|VISION\|PLAN\)\.md$' || echo "")

if [ -n "$GARDEN_CHANGED" ] && [ "${COGNEE_REACHABLE:-false}" = true ]; then
  echo "üìö Knowledge garden files changed this session, syncing to Cognee..."

  # Upload .claude/ files to btc-knowledge-garden dataset
  for file in $(find .claude -type f -name "*.md" | sort); do
    curl -sk -X POST "${COGNEE_URL}/api/v1/add" \
      -F "data=@${file}" \
      -F "datasetName=btc-knowledge-garden" > /dev/null
  done

  # Upload .rules/ files to btc-patterns dataset
  if [ -d .rules ]; then
    for file in $(find .rules -type f -name "*.md" | sort); do
      curl -sk -X POST "${COGNEE_URL}/api/v1/add" \
        -F "data=@${file}" \
        -F "datasetName=btc-patterns" > /dev/null
    done
  fi

  # Cognify both datasets to create knowledge graphs
  curl -sk -X POST "${COGNEE_URL}/api/v1/cognify" \
    -H "Content-Type: application/json" \
    -d '{"datasets": ["btc-knowledge-garden", "btc-patterns"]}' > /dev/null

  echo "‚úì Knowledge garden synced to Cognee"
elif [ -n "$GARDEN_CHANGED" ]; then
  echo "‚ö†Ô∏è  Knowledge garden changed but Cognee not reachable at ${COGNEE_URL}"
else
  echo "‚ÑπÔ∏è  No knowledge garden changes, skipping sync"
fi

# Sync constitution files if changed
if [ -n "$CONSTITUTION_CHANGED" ] && [ "${COGNEE_REACHABLE:-false}" = true ]; then
  echo "üìú Constitution files changed this session, syncing to Cognee..."

  for file in CONSTITUTION.md VISION.md PLAN.md; do
    if [ -f "$file" ]; then
      curl -sk -X POST "${COGNEE_URL}/api/v1/add" \
        -F "data=@${file}" \
        -F "datasetName=btc-constitution" > /dev/null 2>&1
    fi
  done

  # Cognify constitution dataset
  curl -sk -X POST "${COGNEE_URL}/api/v1/cognify" \
    -H "Content-Type: application/json" \
    -d '{"datasets": ["btc-constitution"]}' > /dev/null

  echo "‚úì Constitution synced to Cognee"
elif [ -n "$CONSTITUTION_CHANGED" ]; then
  echo "‚ö†Ô∏è  Constitution changed but Cognee not reachable at ${COGNEE_URL}"
fi
```

**Verification:** Confirm session capture and garden sync succeeded (or were skipped) before proceeding.

## Step 9: Output Clipboard-Ready Handoff (BLOCKING)

‚ö†Ô∏è **THIS STEP IS MANDATORY ‚Äî DO NOT SKIP**

Display this block for the user to copy:

```
## Session Handoff

**Previous Session:** [DATE]
**Branch:** [current branch]
**Last Commit:** [commit hash and message]

### Completed
- [bullet points]

### Pending/Follow-up
- [from bd ready]

### Context
[brief context for next session]
```

## Step 10: Update PLAN.md (Optional)

If significant architectural changes or major milestones were reached, update `PLAN.md`:

```markdown
## Recent Work

**Session**: [DATE]
**Branch**: [branch name]
**Last Commit**: [hash] - [message]

### Major Milestones
- [significant accomplishments only]

### Architecture Changes
- [any architectural decisions or changes]

### Next Major Steps
- [high-level next steps]
```

**Note:** PLAN.md is for major updates only. Day-to-day work is captured in STICKYNOTE.md and Cognee.

## Step 11: Verify Clean State

```bash
git status
```

Must show:
- `nothing to commit, working tree clean`
- `Your branch is up to date with 'origin/<branch>'`

## Step 12: Confirm Completion

Only say "/land complete" when ALL of the above are done.

**FINAL CHECKLIST (all must be true):**

- [ ] Beads synced to kanban
- [ ] Remaining work filed in Beads
- [ ] Beads issues updated
- [ ] Markdown files formatted (Step 4)
- [ ] All changes committed
- [ ] Pushed to remote successfully
- [ ] PR created to dev (or already exists) (Step 6.5)
- [ ] STICKYNOTE.md written with session context
- [ ] Session captured to Cognee (or skipped if not running)
- [ ] Knowledge garden synced to Cognee (if changed)
- [ ] Clipboard handoff block displayed to user
- [ ] PLAN.md updated (if needed)
- [ ] `git status` shows clean + up to date

**NEVER:**

- Declare complete with uncommitted files
- Declare complete without pushing
- Skip formatting (step 4) - formatting issues must be fixed
- Skip STICKYNOTE.md (step 7)
- Skip Cognee capture (step 8) - at minimum attempt it
- Skip clipboard handoff block (step 9)
- Declare complete without showing the final checklist
- Say "ready to push when you are" - YOU must push

## Related Documentation

- [Beads Integration](.rules/patterns/beads-integration.md)
- [Cognee Integration](.rules/architecture/cognee-integration.md)
